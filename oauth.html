<!doctype html>
<html lang=en>
  <head>
    <meta charset=utf-8>
    <title>jpazchat oauth</title>
  </head>
  <body>
    <a id='link' href="">Authenticate</a>
    <pre id='result'></pre>
    <script>
        const link = document.querySelector('#link');
        const result = document.querySelector('#result');

        async function init() {
          const params = new URLSearchParams(`?`+location.hash.replace("#",""));
          const access_token = params.get("access_token");

          link.href = `https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=3ojhrt7dm27vm7a8l0adg314q6aw1w&redirect_uri=${location.origin + location.pathname}&scope=channel:manage:redemptions%20channel:read:redemptions%20user:read:email%20chat:edit%20chat:read`

          try {
            const rsp = await fetch("https://id.twitch.tv/oauth2/validate", {
              headers: {
                "Authorization": `OAuth ${access_token}`
              }
            });

                  console.log(rsp)

            if(rsp.status === 401) {
              throw new Error("Token is invalid")
            }

            const data = await rsp.json();

            result.innerHTML = `Refreshed\n${JSON.stringify(data, null, 2)}`;
            localStorage.setItem("access_token", JSON.stringify({
              access_token
            }));
          } catch(e) {
            result.innerHTML = e.toString();
          }
        }

        init();
    </script>
  </body>
</html>
